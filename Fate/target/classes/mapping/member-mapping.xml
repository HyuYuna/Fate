<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberDao">

	<resultMap type="MemberVO" id="Member">
		<result property="custno" column="custno" />
		<result property="custname" column="CUSTNAME" />
		<result property="phone" column="PHONE" />
		<result property="address" column="address" />
		<result property="joindate" column="JOINDATE" />
		<result property="grade" column="GRADE" />
		<result property="city" column="CITY" />
	</resultMap>
	<resultMap type="MoneyVO" id="Money">
		<result property="custno" column="custno" />
		<result property="price" column="price" /> 
		<result property="custname" column="custname" /> 
		<result property="grade" column="grade" /> 
		<collection property="memberVO" resultMap="Member" /> 
	</resultMap>
	<resultMap type="HashMap" id="Maps">
		<result property="custno" column="custno" />
		<result property="custname" column="CUSTNAME" />
		<result property="phone" column="PHONE" />
		<result property="address" column="address" />
		<result property="joindate" column="JOINDATE" />
		<result property="grade" column="GRADE" />
		<result property="city" column="CITY" />
	</resultMap>
	
	 
	 <update id="editUser" parameterType="MemberVO">
	 <![CDATA[
		UPDATE 
			USER
		SET
			ID = #{id} ,
			PWD = #{pwd}, 
			PWD1 = #{pwd1}
		WHERE
			ID = #{id}
	 ]]>
	</update>
	
	<insert id="insertMember" parameterType="MemberVO">
 	 <![CDATA[
		INSERT INTO MEMBER
		(
			custname, 
			phone, 
			address,
			joindate, 
			grade, 
			city
		) VALUES (
			#{custname}, 
			#{phone}, 
			#{address},
			#{joindate}, 
			#{grade}, 
			#{city}
		) 	
		 ]]>
	</insert>
	
	<insert id="insertFileMember" parameterType="MemberVO">
 	 <![CDATA[
		INSERT INTO MEMBER_FILE
		(
			custname, 
			phone, 
			address,
			joindate, 
			grade, 
			city
		) VALUES (
			#{custname}, 
			#{phone}, 
			#{address},
			#{joindate}, 
			#{grade}, 
			#{city} 
		) 
		 ]]>
		 <selectKey keyProperty="custno" resultType="int" order="AFTER">
		 	SELECT LAST_INSERT_ID()
		 </selectKey>
	</insert>
	
	<delete id="deleteMember" parameterType="Integer">
	 <![CDATA[
	 	DELETE FROM 
	 		MEMBER 
	 	WHERE 
	 		CUSTNO = #{custno}
	 ]]>
	</delete>
	
	<delete id="deleteFileMember" parameterType="Integer">
	 <![CDATA[
	 	DELETE FROM 
	 		MEMBER_FILE
	 	WHERE 
	 		CUSTNO = #{custno}
	 ]]>
	</delete>
	
	<delete id="deleteFile" parameterType="Integer">
	 <![CDATA[
	 	DELETE FROM 
	 		FILE
	 	WHERE 
	 		CUSTNO = #{custno}
	 ]]>
	</delete>
	
	<select id="selectAllmember" parameterType="MemberVO" resultMap="Member">
		SELECT 
			* 
		FROM 
			MEMBER
		<where>
			<if test="ch1=='custno'">
				AND CUSTNO LIKE concat('%',#{ch2},'%')
			</if>
			<if test="ch1=='name'">
				AND CUSTNAME LIKE concat('%',#{ch2},'%')
			</if>
		</where>
		ORDER BY CUSTNO DESC
	</select>
	
	<select id="selectAllMemberJson" resultType="Map">
		SELECT 
			* 
		FROM 
			MEMBER
		ORDER BY CUSTNO DESC
	</select>
	
	
	<select id="selectAllFilemember" parameterType="MemberVO" resultType="MemberVO">
	 <![CDATA[
		SELECT 
			A.custno ,
			A.custname ,
			A.phone ,
			A.address , 
			A.joindate ,
			A.grade ,
			A.city ,
			B.STORED_FILE_NAME AS fname
		FROM 
			MEMBER_FILE AS A
		LEFT JOIN
			FILE AS B ON A.CUSTNO = B.CUSTNO
		GROUP BY
			A.CUSTNO
		ORDER BY 
			A.CUSTNO DESC
	 ]]>
	</select>
	
	<select id="memberCnt" parameterType="MemberVO" resultType="Integer">
	 <![CDATA[
	 	SELECT 
	 		COUNT(*)
	 	FROM
	 		MEMBER 
	 ]]>
	</select>
	
	<select id="memberFileCnt" parameterType="MemberVO" resultType="Integer">
	 <![CDATA[
	 	SELECT 
	 		COUNT(*)
	 	FROM
	 		MEMBER_FILE
	 ]]>
	</select>
	
	<select id="selectMember" parameterType="Integer" resultType="MemberVO">
	  <![CDATA[
	   SELECT 
	   	   * 
	   FROM 
	   	   MEMBER 
	   WHERE 
	   	   CUSTNO = #{custno}
	  ]]>
	</select>
	
	<select id="selectFileMember" parameterType="Integer" resultType="MemberVO">
	  <![CDATA[
	    SELECT 
			custno ,
			custname ,
			phone ,
			address , 
			joindate ,
			grade ,
			city 
		FROM 
			MEMBER_FILE
		WHERE 
	   	   CUSTNO = #{custno}
	    ORDER BY 
			CUSTNO DESC
	  ]]>
	</select>
	
	<select id="selectFileList" parameterType="Integer" resultType="Map">
	  <![CDATA[
	    SELECT 
			NUM ,
			ORIGINAL_FILE_NAME,
		    ROUND(FILE_SIZE/1024,1) AS FILE_SIZE
		FROM 
			FILE
		WHERE 
	   	   CUSTNO = #{custno}
	    ORDER BY 
			CUSTNO DESC
	  ]]>
	</select>
	
	<select id="selectFileInfo" parameterType="Integer" resultType="FileVO">
	  <![CDATA[
	    SELECT 
			CUSTNO ,
			ORIGINAL_FILE_NAME as originalFileName,
		    STORED_FILE_NAME as storedFileName
		FROM 
			FILE
		WHERE 
	   	   NUM = #{num}
	  ]]>
	</select>
	
	<update id="updateMember" parameterType="MemberVO">
	 <![CDATA[
		UPDATE 
			MEMBER 
		SET 
			CUSTNAME= #{custname}, 
			PHONE= #{phone}, 
			ADDRESS= #{address},  
			GRADE= #{grade}, 
			CITY= #{city} 
		WHERE 
			CUSTNO = #{custno}
	 ]]>
	</update>
	
	<select id="moneylist" resultMap="Money">
	  <![CDATA[
	   SELECT 
			M1.CUSTNO AS CUSTNO, M1.CUSTNAME AS CUSTNAME, M1.GRADE AS GRADE,  
			SUM(M2.PRICE) AS PRICE 
		FROM 
			MEMBER M1
		INNER JOIN 
			MONEY M2 ON M1.CUSTNO = M2.CUSTNO 
		GROUP BY 
			M1.CUSTNO, M1.CUSTNAME, M1.GRADE 
		ORDER BY 
			SUM(M2.PRICE) 
	  ]]>
	</select>
	
	<update id="updateFileMember" parameterType="MemberVO">
	 <![CDATA[
		UPDATE 
			MEMBER _FILE
		SET 
			CUSTNAME= #{custname}, 
			PHONE= #{phone}, 
			ADDRESS= #{address},  
			GRADE= #{grade}, 
			CITY= #{city},
			FNAME = #{fname} 
		WHERE 
			CUSTNO = #{custno}
	 ]]>
	</update>
	
	<insert id="insertFile" parameterType="HashMap">
 	 <![CDATA[
		INSERT INTO FILE
		(
			custno, 
			ORIGINAL_FILE_NAME, 
			STORED_FILE_NAME,
			FILE_SIZE 
		) VALUES (
			#{custno}, 
			#{ORIGINAL_FILE_NAME}, 
			#{STORED_FILE_NAME},
			#{FILE_SIZE}
		) 
		 ]]>
	</insert>
	
	
</mapper>